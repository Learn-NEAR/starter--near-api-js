<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Call Contract Methods using NEAR</title>
    <script src="js/near-api-js.js"></script>
    <link rel="stylesheet" href="css/styles.css">
  </head>
  <body>
    <div class="header">
      <a href="#default" class="logo">NEAR Bootcamp Demo</a>
      <div class="header-right">
        <button id="btnLogin">Login to NEAR Account</button>
      </div>
    </div>
    <hr />
    <div class="flex-container">
      <div class="item1">
        <!-- Hello World button -->
        <div id="section"><button id="hello">helloWorld</button></div>
        
        <!-- Read value from given key -->
        <div id="section"><button id="read">read</button> <input type="text" id="read-key" placeholder="key" /></div>

        <!-- Insert key/value pair to contract -->
        <div id="section"><button id="write">write</button> <input type="text" id="write-key" placeholder="key" /> <input type="text" id="write-value" placeholder="value" /></div>
      </div>

      <div class="item2">
        <!-- Get value of current block number  -->
        <div id="section">
          <button id="btnBlock">current block</button> 
          <input type="text" id="blockNum" placeholder="null" disabled/>
          <span id="thanks-ethuil"></span>
        </div>
        <div id="section">
          <button id="btnBalance">contract balance</button> 
          <input type="text" id="contract-balance" placeholder="null" disabled/>
        </div>
        <div id="section">
          <button id="any_balance">get the balance</button>
          <input type="text" id="account_value_id" placeholder="example.testnet"/>
          <span id="amount-in-account"></span>
        </div>
        <div id="section">
          <button id="btnSend">send near</button>
          <input type="text" id="amount_to_send" placeholder="amount in near"/>
          <input type="text" id="send_to_account" placeholder="receiver.testnet"/>
          <span id="send_success"></span>
        </div>
      </div>
      
  
    </div>

    <script>
      (async () => {
        const { connect, keyStores, WalletConnection, Contract, utils } = nearApi;
        const button = document.querySelector('button[id="btnLogin"]');
        const buttonBlock = document.querySelector('button[id="btnBlock"]');
        const buttonAccountValue = document.querySelector('button[id="btnBalance"]');
        const any_account_balance = document.querySelector('button[id="any_balance"]');
        const buttonSend = document.querySelector('button[id="btnSend"]');
        const CONTRACT_ID = 'neardemo2.jacobn.testnet';
        const near = await connect(config());
        const wallet = new WalletConnection(near, 'ncd-ii');
        const dom = setupDOMBindings();

        const contract = new Contract(wallet.account(), CONTRACT_ID, {
          viewMethods: ['helloWorld', 'read', 'get_block', 'get_balance'],
          changeMethods: ['write'],
          sender: wallet.account()
        });


        if (wallet.isSignedIn()) {
          const accountId = wallet.getAccountId();
          button.innerHTML = `Logout ${accountId}`;
          button.addEventListener('click', signOut);
          dom.btnHello.addEventListener('click', async () => console.log(await contract.helloWorld()));
          dom.btnRead.addEventListener('click', async () => console.log(await contract.read({ key: dom.txtReadKey.value })));
          dom.btnWrite.addEventListener('click', async () => console.log(await contract.write({ key: dom.txtWriteKey.value, value: dom.txtWriteValue.value })));
          buttonBlock.addEventListener('click', async () => get_block());
          buttonAccountValue.addEventListener('click', async () => get_balance());
          any_account_balance.addEventListener('click', async () => get_any_balance(document.getElementById("account_value_id").value));
          buttonSend.addEventListener('click', async () => send_tokens(parseInt(document.getElementById('amount_to_send').value), document.getElementById('send_to_account').value));
        } else {
          button.addEventListener('click', signIn);
          dom.btnHello.addEventListener('click', async () => console.log("Please login"));
          dom.btnRead.addEventListener('click', async () => console.log("Please login"));
          dom.btnWrite.addEventListener('click', async () => console.log("Please login"));
          buttonBlock.addEventListener('click', async () => console.log("Please login"));
          buttonAccountValue.addEventListener('click', async () => console.log("Please login"));
        }

        // ------------------------
        // ------------------------
        // Helper functions
        // ------------------------
        // ------------------------

        function signIn() {
          wallet.requestSignIn({
            contractId: 'neardemo2.jacobn.testnet',
            methodNames: ['write']
          });
        }

        function signOut() {
          wallet.signOut();
          location.reload();
        }

        async function get_block() {
          const block = await contract.get_block();
          document.getElementById('blockNum').value = block;
          document.getElementById('thanks-ethuil').innerHTML = "thanks to ethuil for the help";
        }

        async function get_balance() {
          const bal = await contract.get_balance();
          const amountInYocto = await from_yocto(bal);
          document.getElementById('contract-balance').value = amountInYocto;
          console.log(amountInYocto);
        }

        async function get_any_balance(account_name) {
          try
          {
            // gets account balance
            const account = await near.account(account_name);
            const balance = await account.getAccountBalance();
            const avail = balance.available;
            const avail_in_yocto = await from_yocto(avail);
            document.getElementById('amount-in-account').innerHTML = avail_in_yocto;
            const not_in_yocto = toFixed(to_yocto(avail_in_yocto));
            console.log(not_in_yocto);
            console.log(balance);

          }
          catch(ex)
          {
            console.log("Error! Are you sure you put in the correct account ID?");
          }
        }

        async function send_tokens(amount, to_account) {
          // sends NEAR tokens
          const yocto_to_send = await to_yocto(amount);
          const account = await near.account('jacobn.testnet');
          const balance = await account.getAccountBalance();
          const avail = balance.available;
          if (yocto_to_send > avail) {
            console.log("You're too broke");
          } else {
            console.log(`Amount to send is less than available amount, here we go!`);
            await account.sendMoney(
            to_account, // receiver account
            yocto_to_send // amount in yoctoNEAR
            );
          }
        }

        function from_yocto(in_near) {
          var in_yocto = in_near  * 10 ** -24;
          return in_yocto;
        }
        function to_yocto(in_yocto) {
          var in_near = in_yocto * 10 ** 24;
          return in_near;
        }

        function toFixed(x) {
          if (Math.abs(x) < 1.0) {
            var e = parseInt(x.toString().split('e-')[1]);
            if (e) {
                x *= Math.pow(10,e-1);
                x = '0.' + (new Array(e)).join('0') + x.toString().substring(2);
            }
          } else {
            var e = parseInt(x.toString().split('+')[1]);
            if (e > 20) {
                e -= 20;
                x /= Math.pow(10,e);
                x += (new Array(e+1)).join('0');
            }
          }
          return x;
        }


        function config() {
          return {
            networkId: 'testnet',
            keyStore: new keyStores.BrowserLocalStorageKeyStore(),
            nodeUrl: 'https://rpc.testnet.near.org',
            walletUrl: 'https://wallet.testnet.near.org',
            helperUrl: 'https://helper.testnet.near.org',
            explorerUrl: 'https://explorer.testnet.near.org'
          };
        }

        function setupDOMBindings() {
          return {
            btnHello: document.querySelector('#hello'),
            btnRead: document.querySelector('#read'),
            txtReadKey: document.querySelector('#read-key'),
            btnWrite: document.querySelector('#write'),
            txtWriteKey: document.querySelector('#write-key'),
            txtWriteValue: document.querySelector('#write-value')
          };
        }
      })();
    </script>
  </body>
</html>
