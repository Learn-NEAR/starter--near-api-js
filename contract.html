<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Call Contract Methods using NEAR</title>
    <script src="js/near-api-js.js"></script>
    <link rel="stylesheet" href="css/styles.css">
  </head>
  <body>
    <div class="header">
      <a href="#default" class="logo">NEAR Bootcamp Demo</a>
      <div class="header-right">
        <!-- <a href="index.html">home</a> -->
        <!-- <a href="login.html">login</a> -->
        <!-- <a href="contract.html">contract</a> -->
        <button id="btnLogin">Login to NEAR Account</button>
      </div>
    </div>
    <hr />
    <!-- <button>Login</button> -->
    <div class="flex-container">
      <div class="item1">
        <!-- Hello World button -->
        <div id="section"><button id="hello">helloWorld</button></div>
        
        <!-- Read value from given key -->
        <div id="section"><button id="read">read</button> <input type="text" id="read-key" placeholder="key" /></div>

        <!-- Insert key/value pair to contract -->
        <div id="section"><button id="write">write</button> <input type="text" id="write-key" placeholder="key" /> <input type="text" id="write-value" placeholder="value" /></div>
      </div>
      <div class="item2">
        <!-- Get value of given account  -->
        <div id="section"><button id="btnBlock">current block</button> <input type="text" id="account-value" placeholder="null" disabled/></div>
      </div>
  
    </div>

    <script>
      (async () => {
        const { connect, keyStores, WalletConnection, Contract } = nearApi;
        const button = document.querySelector('button[id="btnLogin"]');
        const buttonBlock = document.querySelector('button[id="btnBlock"]');
        const CONTRACT_ID = 'newdemo.jacobn.testnet';
        const near = await connect(config());
        const wallet = new WalletConnection(near, 'ncd-ii');
        const dom = setupDOMBindings();

        const contract = new Contract(wallet.account(), CONTRACT_ID, {
          viewMethods: ['helloWorld', 'read', 'get_block'],
          changeMethods: ['write'],
          sender: wallet.account()
        });


        if (wallet.isSignedIn()) {
          const accountId = wallet.getAccountId();
          button.innerHTML = `Logout ${accountId}`;
          button.addEventListener('click', signOut);
          dom.btnHello.addEventListener('click', async () => console.log(await contract.helloWorld()));
          dom.btnRead.addEventListener('click', async () => console.log(await contract.read({ key: dom.txtReadKey.value })));
          dom.btnWrite.addEventListener('click', async () => console.log(await contract.write({ key: dom.txtWriteKey.value, value: dom.txtWriteValue.value })));
          buttonBlock.addEventListener('click', async () => console.log(await contract.get_block()));
        } else {
          button.addEventListener('click', signIn);
          dom.btnHello.addEventListener('click', async () => console.log("Please login"));
          dom.btnRead.addEventListener('click', async () => console.log("Please login"));
          dom.btnWrite.addEventListener('click', async () => console.log("Please login"));
          buttonBlock.addEventListener('click', async () => console.log("Please login"));
        }

        // ------------------------
        // ------------------------
        // Helper functions
        // ------------------------
        // ------------------------

        function signIn() {
          wallet.requestSignIn({
            contractId: 'newdemo.jacobn.testnet',
            methodNames: ['write']
          });
        }

        function signOut() {
          wallet.signOut();
          location.reload();
        }

        function get_block() {
          contract.get_block();
        }


        function config() {
          return {
            networkId: 'testnet',
            keyStore: new keyStores.BrowserLocalStorageKeyStore(),
            nodeUrl: 'https://rpc.testnet.near.org',
            walletUrl: 'https://wallet.testnet.near.org',
            helperUrl: 'https://helper.testnet.near.org',
            explorerUrl: 'https://explorer.testnet.near.org'
          };
        }

        function setupDOMBindings() {
          return {
            btnHello: document.querySelector('#hello'),
            btnRead: document.querySelector('#read'),
            txtReadKey: document.querySelector('#read-key'),
            btnWrite: document.querySelector('#write'),
            txtWriteKey: document.querySelector('#write-key'),
            txtWriteValue: document.querySelector('#write-value')
          };
        }
      })();
    </script>
  </body>
</html>
